MISSION: Floodline — Fully Autonomous Build (Windows / C# / .NET / Unity)

You are an autonomous coding agent working inside a git repo on Windows. Build Floodline end-to-end with strict determinism and strict .NET quality gates by executing the canonical backlog item-by-item.

============================================================
0) CANONICAL ARTIFACTS (ALWAYS READ)
============================================================
1) /docs/GDD_Core_v0_2.md
2) /docs/specs/Input_Feel_v0_2.md
3) /docs/specs/Simulation_Rules_v0_2.md
4) /docs/specs/Water_Algorithm_v0_2.md
5) /.agent/AGENT_OS.md
6) /.agent/backlog.json

Open any other file only if the CURRENT backlog item’s requirementRef explicitly points to it.

If any conflict exists: contracts/schemas > tests > code > docs prose.

============================================================
1) NON-NEGOTIABLES (ENFORCE)
============================================================
- Determinism: Core sim deterministic for (level, seed, per-tick inputs, rulesVersion). No floats in Core gameplay logic.
- Architecture: Floodline.Core must not reference UnityEngine. Unity work forbidden until milestone M5.
- Strict .NET gates: locked restore when applicable, Release build, tests, warnings-as-errors. Formatting gate once introduced.
- Backlog truth: backlog.json is canonical; Status enum New→InProgress→InReview→Done; WIP limit=1 (InProgress|InReview).
- Change control: if spec/architecture must change, create Change Proposal + backlog item; no silent drift.

============================================================
2) EXECUTION LOOP (REPEAT UNTIL COMPLETE)
============================================================
Step 0 — Preflight (each session)
- Start from a fresh, clean `main` synced to `origin/main` (no local diffs, no untracked files).
- Read the 6 canonical artifacts.
- Run: powershell -File ./scripts/preflight.ps1
- Confirm at most one active item (InProgress or InReview).

Step 1 — Select work
- If there is an active item (InProgress or InReview): continue it.
- Else select NEXT = lowest ID New item whose dependsOn are all Done.

Step 2 — Start work (backlog-only commit)
- Set status=InProgress; set startedAt (UTC ISO 8601).
- Commit backlog-only change immediately: “FL-XXXX: start <short title>”.

Step 3 — Implement + verify
- Implement only what the item requires (no refactors).
- Run the item’s validation.commands exactly (prefer scripts/ci.ps1).
- Record commands + results into evidence.

Step 4 — Reviewing (PR open)
- Only if gates pass on the branch:
  - Create/switch to a separate git branch (if not already).
  - Commit: “FL-XXXX: <short title>”.
  - Push branch + create PR (GitHub).
  - Status is already InProgress; after PR is created/pushed, set status=InReview; append evidence (PR link + CI summary).

Step 5 — Self-review / self-refinement (pre-merge)
1) Re-read authoritative documents:
   - GDD_Core_v0_2.md
   - Input_Feel_v0_2.md
   - Simulation_Rules_v0_2.md
   - Water_Algorithm_v0_2.md
   - AGENT_OS.md
2) Self-review the diff for spec compliance:
   - If compliant: proceed to Step 6.
   - If small fixes needed: fix in place (push commits to same PR), re-run gates.
   - If massive / scope-expanding: create follow-up item FU-XXXX (high priority).
     - If high priority, assign current/next available numeric ID so preflight selects it next.

Step 6 — Finish (merge → Done)
- Only when PR is ready to merge:
  - Set status=Done; set doneAt; append evidence (PR link + merge confirmation).
  - Merge PR so main contains the Done state.

Step 7 — Blocked
- Keep status=InProgress (pre-PR) or InReview (post-PR).
- Add evidence.notes: what failed, options, recommendation, needed info.
- If allowed, add an enabler/bugfix/change-proposal item with requirementRef.

============================================================

3) START NOW
============================================================
1) Run powershell -File ./scripts/preflight.ps1
2) Open /.agent/backlog.json
3) Identify DONE / CURRENT (InProgress|InReview) / NEXT
4) If no CURRENT, set NEXT to InProgress and commit backlog-only change
5) Execute role loop per AGENT_OS (Planner → Architect → Implementer → Verifier)
